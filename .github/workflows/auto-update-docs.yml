name: üìö Auto-Update Documentation

on:
  push:
    branches:
      - main
      - integration/vln
      - 'feature/**'
      - 'fix/**'
      - 'docs/**'
      - 'claude/**'
    paths:
      - 'docs/_source/**'
      - 'docs/_adapters/**'
      - '.github/workflows/auto-update-docs.yml'
      - 'scripts/sync-*.js'
      - 'scripts/compile-*.js'
  pull_request:
    types: [opened, synchronize, closed]
    branches:
      - main
      - integration/vln
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-content:
    name: üîÑ Sync Documentation Content
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîÑ Sync Content via Adapters
        run: |
          node scripts/sync-content.js

      - name: ‚úÖ Validate Sync Integrity
        run: |
          node scripts/validate-sync.js

      - name: üìù Generate Blog Entries from Documentation
        id: blog_generation
        run: |
          node scripts/generate-blog-entries.js
          echo "blog_generated=true" >> $GITHUB_OUTPUT

      - name: üìö Sync Blog Content
        if: steps.blog_generation.outputs.blog_generated == 'true'
        run: |
          node scripts/sync-blog.js

      - name: üìã Generate Merge Summary
        id: merge_summary
        if: github.event_name == 'push'
        run: |
          node scripts/compile-merge-summary.js integration/vln || true
          echo "summary_generated=true" >> $GITHUB_OUTPUT

      - name: üíæ Commit Synced Content
        id: commit
        if: github.event_name == 'push'
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git config --local user.name "VLN Documentation Bot"
            git config --local user.email "bot@vln.gg"
            git add docs/_sync docs/_generated
            git commit -m "docs(sync): auto-sync content from source

          Automated documentation sync from docs/_source via adapters
          - design-site content synchronized
          - docs-site content synchronized
          - Blog entries generated from documentation
          - Sync integrity validated

          ü§ñ Generated by VLN Documentation Bot"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Push Synced Changes
        if: steps.commit.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

  build-starlight-sites:
    name: üèóÔ∏è Build Documentation Sites
    runs-on: ubuntu-latest
    needs: sync-content
    if: always()

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: üì¶ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design-site
        run: pnpm design:build

      - name: üèóÔ∏è Build docs-site
        run: pnpm docs:build

  validate-documentation:
    name: ‚úÖ Validate Documentation
    runs-on: ubuntu-latest
    needs: sync-content
    if: always()

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîç Validate Markdown Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: üîç Validate Adapter Configuration
        run: |
          node -e "
            const fs = require('fs');
            const designAdapter = JSON.parse(fs.readFileSync('docs/_adapters/design-site.adapter.json', 'utf-8'));
            const docsAdapter = JSON.parse(fs.readFileSync('docs/_adapters/docs-site.adapter.json', 'utf-8'));
            console.log('‚úì design-site adapter valid');
            console.log('‚úì docs-site adapter valid');
          "

  notify-on-complete:
    name: üîî Notify Status
    runs-on: ubuntu-latest
    needs: [sync-content, build-starlight-sites, validate-documentation]
    if: always()

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìä Generate Status Report
        id: status
        run: |
          if [ "${{ needs.sync-content.result }}" == "success" ]; then
            echo "sync_status=‚úÖ"
            echo "sync_text=Sync passed"
          else
            echo "sync_status=‚ùå"
            echo "sync_text=Sync failed"
          fi

          if [ "${{ needs.build-starlight-sites.result }}" == "success" ]; then
            echo "build_status=‚úÖ"
            echo "build_text=Build passed"
          else
            echo "build_status=‚ùå"
            echo "build_text=Build failed"
          fi

          if [ "${{ needs.validate-documentation.result }}" == "success" ]; then
            echo "validate_status=‚úÖ"
            echo "validate_text=Validation passed"
          else
            echo "validate_status=‚ö†Ô∏è"
            echo "validate_text=Validation warnings"
          fi

      - name: üí¨ Create PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |-
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìö Documentation Sync Report

| Check | Status |
|-------|--------|
| Content Sync | ${{ env.sync_status }} ${{ env.sync_text }} |
| Site Build | ${{ env.build_status }} ${{ env.build_text }} |
| Validation | ${{ env.validate_status }} ${{ env.validate_text }} |

### üìÅ Files Synchronized
- ‚úÖ design-site content
- ‚úÖ docs-site content
- ‚úÖ Generated artifacts

ü§ñ Generated by VLN Documentation Bot`
            })
          env:
            sync_status: ${{ steps.status.outputs.sync_status }}
            sync_text: ${{ steps.status.outputs.sync_text }}
            build_status: ${{ steps.status.outputs.build_status }}
            build_text: ${{ steps.status.outputs.build_text }}
            validate_status: ${{ steps.status.outputs.validate_status }}
            validate_text: ${{ steps.status.outputs.validate_text }}

  update-documentation:
    name: üìù Legacy Documentation Update
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Extract Commit Information
        id: commit_info
        run: |
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=%cd --date=iso)" >> $GITHUB_OUTPUT

          # Extract conventional commit type
          COMMIT_MSG=$(git log -1 --pretty=%s)
          if [[ $COMMIT_MSG =~ ^(feat|fix|docs|chore|style|refactor|perf|test)(\(.*\))?:(.*)$ ]]; then
            echo "commit_type=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "commit_scope=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "commit_subject=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          else
            echo "commit_type=other" >> $GITHUB_OUTPUT
            echo "commit_subject=$COMMIT_MSG" >> $GITHUB_OUTPUT
          fi

      - name: Update CHANGELOG.md
        if: hashFiles('scripts/update-changelog.js') != ''
        run: |
          node scripts/update-changelog.js \
            --type "${{ steps.commit_info.outputs.commit_type }}" \
            --scope "${{ steps.commit_info.outputs.commit_scope }}" \
            --subject "${{ steps.commit_info.outputs.commit_subject }}" \
            --sha "${{ steps.commit_info.outputs.commit_sha }}" \
            --author "${{ steps.commit_info.outputs.commit_author }}" \
            --date "${{ steps.commit_info.outputs.commit_date }}"

      - name: Update Feature Status in README.md
        if: hashFiles('scripts/update-feature-status.js') != ''
        run: node scripts/update-feature-status.js

      - name: Update ROADMAP.md Progress
        if: hashFiles('scripts/update-roadmap.js') != ''
        run: node scripts/update-roadmap.js

      - name: Generate Documentation Index
        if: hashFiles('scripts/generate-doc-index.js') != ''
        run: node scripts/generate-doc-index.js

      - name: Update Component Documentation
        if: hashFiles('scripts/update-component-docs.js') != '' && contains(github.event.head_commit.message, 'component')
        run: node scripts/update-component-docs.js

      - name: Update Security Documentation
        if: hashFiles('scripts/update-security-docs.js') != '' && (contains(github.event.head_commit.message, 'security') || contains(github.event.head_commit.message, 'sec'))
        run: node scripts/update-security-docs.js

      - name: Check for Documentation Changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Documentation Updates
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "VLN Documentation Bot"
          git config --local user.email "bot@vln.gg"
          git add CHANGELOG.md README.md ROADMAP.md docs/
          git commit -m "docs(auto): update documentation from commit ${{ steps.commit_info.outputs.commit_sha }}

          Automated documentation update triggered by:
          - Type: ${{ steps.commit_info.outputs.commit_type }}
          - Scope: ${{ steps.commit_info.outputs.commit_scope }}
          - Subject: ${{ steps.commit_info.outputs.commit_subject }}
          - Author: ${{ steps.commit_info.outputs.commit_author }}

          ü§ñ Automated by GitHub Actions"

      - name: Push Documentation Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Create or Update PR Comment
        if: github.event_name == 'pull_request' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üìö Documentation Updated\n\nAutomated documentation has been updated based on this PR:\n\n- ‚úÖ CHANGELOG.md updated\n- ‚úÖ Feature status in README.md refreshed\n- ‚úÖ ROADMAP.md progress updated\n\nü§ñ Generated automatically by VLN Documentation Bot'
            })

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    needs: update-documentation

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Markdown Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

      - name: Validate CHANGELOG Format
        run: |
          if ! grep -q "## \[" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md format is invalid"
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md format is valid"

      - name: Validate README Badges
        run: |
          if ! grep -q "!\[Build Status\]" README.md; then
            echo "‚ö†Ô∏è  Missing build status badge in README.md"
          fi
          if ! grep -q "!\[Version\]" README.md; then
            echo "‚ö†Ô∏è  Missing version badge in README.md"
          fi
          echo "‚úÖ README badges validated"

      - name: Check Documentation Coverage
        run: |
          # Check if all pages have corresponding documentation
          PAGES=(
            "app/page.tsx:docs/design/ux-flows/homepage.md"
            "app/contact/page.tsx:docs/design/ux-flows/contact-flow.md"
            "app/services/page.tsx:docs/design/ux-flows/services-navigation.md"
          )

          for pair in "${PAGES[@]}"; do
            IFS=: read -r page doc <<< "$pair"
            if [[ -f "$page" && ! -f "$doc" ]]; then
              echo "‚ö†Ô∏è  Missing documentation for $page"
            fi
          done
          echo "‚úÖ Documentation coverage check complete"

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [update-documentation, validate-docs]
    if: always()

    steps:
      - name: Send Discord Notification
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/integration/vln'
        run: |
          # Determine status emoji and color
          if [ "${{ needs.update-documentation.result }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="Success"
            COLOR="3066993"  # Green
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Failed"
            COLOR="15158332"  # Red
          fi

          # Get commit URL
          COMMIT_URL="${{ github.event.head_commit.url }}"
          if [ -z "$COMMIT_URL" ]; then
            COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi

          # Send Discord webhook (use secret for security)
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üìö Documentation Update",
                "description": "Automated documentation has been updated",
                "color": '"$COLOR"',
                "fields": [
                  {
                    "name": "Branch",
                    "value": "`${{ github.ref_name }}`",
                    "inline": true
                  },
                  {
                    "name": "Status",
                    "value": "'"$STATUS_EMOJI"' '"$STATUS_TEXT"'",
                    "inline": true
                  },
                  {
                    "name": "Author",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "[`'"${GITHUB_SHA:0:7}"'`]('"$COMMIT_URL"')",
                    "inline": false
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'",
                "footer": {
                  "text": "VLN Documentation Bot"
                }
              }]
            }' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
