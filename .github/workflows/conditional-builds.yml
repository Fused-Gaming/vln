name: Conditional Builds - Skip if No Changes

on:
  push:
    branches: ["main", "development", "integration/vln"]
  pull_request:
    branches: ["main", "development", "integration/vln"]

jobs:
  # Detect changes to docs-site
  detect-docs-changes:
    name: ðŸ“ Detect Docs Changes
    runs-on: ubuntu-latest
    outputs:
      docs-changed: ${{ steps.check-docs.outputs.changed }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for docs-site changes
        id: check-docs
        run: |
          if git diff origin/${{ github.base_ref || 'development' }}...HEAD --name-only | grep -q "^docs-site/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in docs-site/"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No changes in docs-site/ - skipping build"
          fi

  # Detect changes to design-site
  detect-design-changes:
    name: ðŸŽ¨ Detect Design Site Changes
    runs-on: ubuntu-latest
    outputs:
      design-changed: ${{ steps.check-design.outputs.changed }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for design-site changes
        id: check-design
        run: |
          if git diff origin/${{ github.base_ref || 'development' }}...HEAD --name-only | grep -q "^design-site/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in design-site/"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No changes in design-site/ - skipping build"
          fi

  # Build docs-site only if changed
  build-docs:
    name: ðŸ“š Build Docs Site
    runs-on: ubuntu-latest
    needs: detect-docs-changes
    if: needs.detect-docs-changes.outputs.docs-changed == 'true'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build docs-site
        run: pnpm docs:build

      - name: âœ… Docs build successful
        run: echo "Docs site built successfully"

  # Build design-site only if changed
  build-design:
    name: ðŸŽ¨ Build Design Site
    runs-on: ubuntu-latest
    needs: detect-design-changes
    if: needs.detect-design-changes.outputs.design-changed == 'true'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build design-site
        run: pnpm design:build

      - name: âœ… Design build successful
        run: echo "Design site built successfully"

  # Always run for main app (no skipping)
  check-main-app:
    name: âœ… Check Conditional Builds Summary
    runs-on: ubuntu-latest
    needs: [detect-docs-changes, detect-design-changes]
    if: always()
    steps:
      - name: ðŸ“Š Build Summary
        run: |
          echo "### Conditional Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs Site**: ${{ needs.detect-docs-changes.outputs.docs-changed == 'true' && 'âœ… Built' || 'â­ï¸ Skipped (no changes)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Design Site**: ${{ needs.detect-design-changes.outputs.design-changed == 'true' && 'âœ… Built' || 'â­ï¸ Skipped (no changes)' }}" >> $GITHUB_STEP_SUMMARY
