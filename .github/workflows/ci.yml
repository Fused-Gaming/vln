name: VLN CI/CD Pipeline

on:
  push:
    branches: ["main", "integration/vln"]
  pull_request:
    branches: ["main", "integration/vln"]
  workflow_dispatch:

env:
  NODE_VERSION: "20.x"

jobs:
  security-audit:
    name: ğŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ VLN Security & Dependency Audit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Repository: ${{ github.repository }}"
          echo "âœ“ Branch: ${{ github.ref_name }}"
          echo "âœ“ Commit: ${{ github.sha }}"
          echo "âœ“ Author: ${{ github.actor }}"

      - name: ğŸ” Check for exposed secrets
        run: |
          # Check if .env is tracked
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "âŒ CRITICAL: .env file is tracked in git!"
            exit 1
          fi
          echo "âœ“ No .env file tracked in git"

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping Node.js steps"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ” pnpm Audit
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running pnpm security audit..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm audit --prod || echo "âš ï¸  Vulnerabilities found - review required"

  lint:
    name: ğŸ¨ Lint & Type Check
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping lint"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: pnpm install --frozen-lockfile

      - name: ğŸ¨ Run ESLint
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        run: pnpm lint

      - name: ğŸ” Type Check
        if: steps.check_package.outputs.has_package == 'true'
        run: pnpm tsc --noEmit

  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping build"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: |
          set -e
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Installing dependencies..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm install --frozen-lockfile
          echo "âœ“ Dependencies installed successfully"

      - name: ğŸ—ï¸  Build project
        if: steps.check_package.outputs.has_package == 'true'
        run: |
          set -e
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Building VLN website..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm build

          # Verify .next directory was created
          if [ ! -d ".next" ]; then
            echo "âŒ ERROR: Build did not produce .next directory"
            exit 1
          fi

          echo "âœ“ Build completed successfully"
          echo "âœ“ Output folder verified (.next/ exists)"

      - name: ğŸ§ª Run tests
        if: steps.check_package.outputs.has_package == 'true'
        run: |
          set -e

          # Verify build output exists before testing
          if [ ! -d ".next" ]; then
            echo "âŒ ERROR: Output folder .next/ does not exist - cannot run tests"
            exit 1
          fi
          echo "âœ“ Output folder verified before testing"

          # Check if any test files exist
          if find . -name "*.test.*" -o -name "*.spec.*" | grep -q .; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â†’ Running tests against build..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            pnpm test || echo "âš ï¸  Tests found but some failed - continuing"
            echo "âœ“ Test step completed"
          else
            echo "âš ï¸  No test files found - skipping tests"
            echo "   (Tests will run when *.test.* or *.spec.* files are added)"
          fi

      - name: ğŸ“Š Upload build artifacts
        if: steps.check_package.outputs.has_package == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  summary:
    name: ğŸ“‹ Pipeline Summary & Diagnostics
    runs-on: ubuntu-latest
    needs: [security-audit, lint, build-and-test]
    if: always()
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate Pipeline Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VLN CI/CD Pipeline Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Job Results:"
          echo "  Security Audit:  ${{ needs.security-audit.result }}"
          echo "  Lint:            ${{ needs.lint.result }}"
          echo "  Build & Test:    ${{ needs.build-and-test.result }}"

      - name: ğŸ” Run Diagnostics on Failure
        if: |
          needs.security-audit.result != 'success' ||
          needs.lint.result != 'success' ||
          needs.build-and-test.result != 'success'
        id: diagnostics
        continue-on-error: true
        run: |
          chmod +x .github/scripts/analyze-build-failure.sh
          .github/scripts/analyze-build-failure.sh

      - name: ğŸ“ Create/Update Diagnostic Issue
        if: |
          needs.security-audit.result != 'success' ||
          needs.lint.result != 'success' ||
          needs.build-and-test.result != 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const diagnosticReport = fs.existsSync('diagnostic-report.md')
              ? fs.readFileSync('diagnostic-report.md', 'utf8')
              : '## âš ï¸ Build Failed\n\nAutomated diagnostics could not run. Please check the workflow logs.';

            const issueTitle = 'ğŸ” Build Diagnostics Report';
            const issueBody = `${diagnosticReport}

            ---

            ## ğŸ“Š Latest Build Information

            **Pipeline Results:**
            - ğŸ”’ Security Audit: \`${{ needs.security-audit.result }}\`
            - ğŸ¨ Lint & Type Check: \`${{ needs.lint.result }}\`
            - ğŸ”¨ Build & Test: \`${{ needs.build-and-test.result }}\`

            **Branch:** \`${{ github.ref_name }}\`
            **Commit:** ${{ github.sha }}
            **Triggered by:** @${{ github.actor }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---

            <sub>ğŸ¤– This issue is automatically updated by [VLN Build Diagnostics](.github/scripts/analyze-build-failure.sh)</sub>
            <sub>Last updated: ${new Date().toISOString()}</sub>`;

            // Search for existing diagnostic issue (both open and closed)
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['build-diagnostics'],
              per_page: 100
            });

            const { data: closedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: ['build-diagnostics'],
              per_page: 10,
              sort: 'updated',
              direction: 'desc'
            });

            const allIssues = [...openIssues, ...closedIssues];
            const existingIssue = allIssues.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              // Reopen if closed
              if (existingIssue.state === 'closed') {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  state: 'open'
                });
                console.log(\`Reopened diagnostic issue #\${existingIssue.number}\`);
              }

              // Update issue body
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(\`Updated diagnostic issue #\${existingIssue.number}\`);

              // Add a comment with the new failure info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: \`## ğŸ”„ New Build Failure Detected

            **Branch:** \`${{ github.ref_name }}\`
            **Commit:** \`${{ github.sha }}\`
            **Time:** ${new Date().toISOString()}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            See updated diagnostics in the issue description above.\`
              });
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['build-diagnostics', 'automation']
              });
              console.log(\`Created new diagnostic issue #\${newIssue.data.number}\`);
            }

      - name: ğŸ‰ Success Actions
        if: |
          needs.security-audit.result == 'success' &&
          needs.lint.result == 'success' &&
          needs.build-and-test.result == 'success'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All pipeline steps completed successfully!"
          echo "ğŸ‰ Ready to merge!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âœ… Close Diagnostic Issue on Success
        if: |
          needs.security-audit.result == 'success' &&
          needs.lint.result == 'success' &&
          needs.build-and-test.result == 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const issueTitle = 'ğŸ” Build Diagnostics Report';

            // Search for existing diagnostic issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['build-diagnostics'],
              per_page: 100
            });

            const existingIssue = issues.find(issue =>
              issue.title === issueTitle
            );

            if (existingIssue) {
              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## âœ… Build Fixed!

            All pipeline checks are now passing.

            **Branch:** \`${{ github.ref_name }}\`
            **Commit:** ${{ github.sha }}
            **Time:** ${new Date().toISOString()}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Closing this issue. It will be reopened automatically if builds fail again.`
              });

              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });

              console.log(\`Closed diagnostic issue #\${existingIssue.number}\`);
            } else {
              console.log('No open diagnostic issue found - nothing to close');
            }

      - name: âœ… Final Status Check
        run: |
          if [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "âŒ Pipeline failed - diagnostics posted above"
            exit 1
          fi
