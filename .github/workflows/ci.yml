name: VLN CI/CD Pipeline

on:
  push:
    branches: ["main", "integration/vln"]
  pull_request:
    branches: ["main", "integration/vln"]
  workflow_dispatch:

env:
  NODE_VERSION: "20.x"

jobs:
  security-audit:
    name: ğŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¯ Setup Environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ VLN Security & Dependency Audit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Repository: ${{ github.repository }}"
          echo "âœ“ Branch: ${{ github.ref_name }}"
          echo "âœ“ Commit: ${{ github.sha }}"
          echo "âœ“ Author: ${{ github.actor }}"

      - name: ğŸ” Check for exposed secrets
        run: |
          # Check if .env is tracked
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "âŒ CRITICAL: .env file is tracked in git!"
            exit 1
          fi
          echo "âœ“ No .env file tracked in git"

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping Node.js steps"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ” pnpm Audit
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Running pnpm security audit..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm audit --prod || echo "âš ï¸  Vulnerabilities found - review required"

  lint:
    name: ğŸ¨ Lint & Type Check
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping lint"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: pnpm install --frozen-lockfile

      - name: ğŸ¨ Run ESLint
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        run: pnpm lint

      - name: ğŸ” Type Check
        if: steps.check_package.outputs.has_package == 'true'
        run: pnpm tsc --noEmit

  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Check for package.json
        id: check_package
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
            echo "âœ“ package.json found"
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No package.json found - skipping build"
          fi

      - name: ğŸ“¦ Setup pnpm
        if: steps.check_package.outputs.has_package == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        if: steps.check_package.outputs.has_package == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        if: steps.check_package.outputs.has_package == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Installing dependencies..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm install --frozen-lockfile
          echo "âœ“ Dependencies installed successfully"

      - name: ğŸ§ª Run tests
        if: steps.check_package.outputs.has_package == 'true'
        continue-on-error: true
        run: |
          if pnpm test --help &>/dev/null; then
            pnpm test
          else
            echo "âš ï¸  No tests configured yet"
          fi

      - name: ğŸ—ï¸  Build project
        if: steps.check_package.outputs.has_package == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â†’ Building VLN website..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pnpm build
          echo "âœ“ Build completed successfully"

          # Verify .next directory was created
          if [ ! -d ".next" ]; then
            echo "âŒ ERROR: .next directory not created"
            exit 1
          fi
          echo "âœ“ Build artifacts verified (.next directory exists)"

      - name: ğŸ“Š Upload build artifacts
        if: steps.check_package.outputs.has_package == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  summary:
    name: ğŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [security-audit, lint, build-and-test]
    if: always()
    steps:
      - name: ğŸ“Š Generate Final Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VLN CI/CD Pipeline Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Job Results:"
          echo "  Security Audit:  ${{ needs.security-audit.result }}"
          echo "  Lint:            ${{ needs.lint.result }}"
          echo "  Build & Test:    ${{ needs.build-and-test.result }}"

      - name: âœ… Check Overall Status
        run: |
          if [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "âŒ Pipeline failed - please review the errors above"
            exit 1
          else
            echo "âœ… All pipeline steps completed successfully!"
            echo "ğŸ‰ Ready to merge!"
          fi
